<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–©–æ–¥–µ–Ω–Ω–∏–π –∑–≤—ñ—Ç</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        h1 {
            font-size: 24px;
            margin-bottom: 10px;
            color: var(--tg-theme-text-color);
        }

        .date {
            color: var(--tg-theme-hint-color, #999);
            margin-bottom: 20px;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--tg-theme-text-color);
        }

        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--tg-theme-hint-color, #ddd);
            border-radius: 8px;
            font-size: 16px;
            background: var(--tg-theme-bg-color, #fff);
            color: var(--tg-theme-text-color, #000);
            font-family: inherit;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--tg-theme-button-color, #3390ec);
        }

        .task-list {
            margin-top: 10px;
        }

        .task-item {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid var(--tg-theme-hint-color, #ddd);
            border-radius: 8px;
            background: var(--tg-theme-secondary-bg-color, #f5f5f5);
        }

        .task-item .task-theme {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 8px;
            min-height: 50px;
        }

        .task-item .task-description {
            margin-bottom: 10px;
            min-height: 100px;
        }

        .task-item-controls {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .task-hours, .task-minutes {
            width: 70px;
            text-align: center;
        }

        .time-separator {
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: var(--tg-theme-text-color);
            width: 20px;
            flex-shrink: 0;
        }

        .task-item-controls select {
            width: 150px;
            flex-shrink: 0;
        }

        .btn-remove {
            padding: 12px;
            background: #ff3b30;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .btn-add {
            padding: 10px 16px;
            background: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #fff);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
        }

        .error {
            color: #ff3b30;
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }

        .success-message {
            background: #34c759;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        @media (max-width: 480px) {
            .task-hours, .task-minutes {
                width: 60px;
                font-size: 14px;
                padding: 10px 8px;
            }

            .task-item-controls select {
                width: 120px;
                font-size: 14px;
                padding: 10px 8px;
            }

            .btn-remove {
                width: 36px;
                height: 36px;
                padding: 8px;
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìß –©–æ–¥–µ–Ω–Ω–∏–π –∑–≤—ñ—Ç (—è–∫ –ª–∏—Å—Ç –Ω–∞ –ø–æ—à—Ç—ñ)</h1>
        <div class="date" id="currentDate"></div>

        <div class="success-message" id="successMessage">
            ‚úÖ –ó–≤—ñ—Ç —É—Å–ø—ñ—à–Ω–æ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ!
        </div>

        <form id="reportForm">
            <div class="form-group">
                <label for="tasks">–í–∏–∫–æ–Ω–∞–Ω—ñ –∑–∞–≤–¥–∞–Ω–Ω—è *</label>
                <div class="task-list" id="taskList">
                    <div class="task-item">
                        <input type="text" class="task-theme" placeholder="–ó–∞–≤–¥–∞–Ω–Ω—è" required>
                        <textarea class="task-description" placeholder="–û–ø–∏—Å..." required></textarea>
                        <div class="task-item-controls">
                            <input type="number" class="task-hours" min="0" max="24" placeholder="–ì–æ–¥" required>
                            <div class="time-separator">:</div>
                            <input type="number" class="task-minutes" min="0" max="59" placeholder="–•–≤" required>
                            <select class="task-status" required>
                                <option value="completed">‚úÖ –í–∏–∫–æ–Ω–∞–Ω–æ</option>
                                <option value="in_progress">üîÑ –í –ø—Ä–æ—Ü–µ—Å—ñ</option>
                                <option value="blocked">üö´ –ë–ª–æ–∫–µ—Ä–∏</option>
                            </select>
                            <button type="button" class="btn-remove" onclick="removeTask(this)" title="–í–∏–¥–∞–ª–∏—Ç–∏">√ó</button>
                        </div>
                    </div>
                </div>
                <button type="button" class="btn-add" onclick="addTask()">+ –î–æ–¥–∞—Ç–∏ –∑–∞–≤–¥–∞–Ω–Ω—è</button>
                <div class="error" id="tasksError">–î–æ–¥–∞–π—Ç–µ —Ö–æ—á–∞ –± –æ–¥–Ω–µ –∑–∞–≤–¥–∞–Ω–Ω—è</div>
            </div>
        </form>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –ø–æ—Ç–æ—á–Ω—É –¥–∞—Ç—É
        const dateOptions = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
        document.getElementById('currentDate').textContent = 
            new Date().toLocaleDateString('uk-UA', dateOptions);

        // –î–æ–¥–∞–≤–∞–Ω–Ω—è –Ω–æ–≤–æ–≥–æ –∑–∞–≤–¥–∞–Ω–Ω—è
        function addTask() {
            const taskList = document.getElementById('taskList');
            const taskItem = document.createElement('div');
            taskItem.className = 'task-item';
            taskItem.innerHTML = `
                <input type="text" class="task-theme" placeholder="–ó–∞–≤–¥–∞–Ω–Ω—è" required>
                <textarea class="task-description" placeholder="–û–ø–∏—Å..." required></textarea>
                <div class="task-item-controls">
                    <input type="number" class="task-hours" min="0" max="24" placeholder="–ì–æ–¥" required>
                    <div class="time-separator">:</div>
                    <input type="number" class="task-minutes" min="0" max="59" placeholder="–•–≤" required>
                    <select class="task-status" required>
                        <option value="completed">‚úÖ –í–∏–∫–æ–Ω–∞–Ω–æ</option>
                        <option value="in_progress">üîÑ –í –ø—Ä–æ—Ü–µ—Å—ñ</option>
                        <option value="blocked">üö´ –ë–ª–æ–∫–µ—Ä–∏</option>
                    </select>
                    <button type="button" class="btn-remove" onclick="removeTask(this)" title="–í–∏–¥–∞–ª–∏—Ç–∏">√ó</button>
                </div>
            `;
            taskList.appendChild(taskItem);
        }

        // –í–∏–¥–∞–ª–µ–Ω–Ω—è –∑–∞–≤–¥–∞–Ω–Ω—è
        function removeTask(button) {
            const taskList = document.getElementById('taskList');
            if (taskList.children.length > 1) {
                const taskItem = button.closest('.task-item');
                if (taskItem) {
                    taskItem.remove();
                }
            } else {
                alert('–ú–∞—î –±—É—Ç–∏ —Ö–æ—á–∞ –± –æ–¥–Ω–µ –∑–∞–≤–¥–∞–Ω–Ω—è');
            }
        }

        // –í–∞–ª—ñ–¥–∞—Ü—ñ—è —Ñ–æ—Ä–º–∏
        function validateForm() {
            let isValid = true;
            const taskItems = document.querySelectorAll('.task-item');
            let hasValidTask = false;

            for (const item of taskItems) {
                const theme = item.querySelector('.task-theme');
                const description = item.querySelector('.task-description');
                const hoursEl = item.querySelector('.task-hours');
                const minutesEl = item.querySelector('.task-minutes');
                const status = item.querySelector('.task-status');

                const themeText = theme?.value.trim() || '';
                const descText = description?.value.trim() || '';
                const hours = hoursEl?.value !== '' ? parseInt(hoursEl.value, 10) : NaN;
                const minutes = minutesEl?.value !== '' ? parseInt(minutesEl.value, 10) : NaN;
                const statusValue = status?.value || '';

                const validHours = !isNaN(hours) && hours >= 0 && hours <= 24;
                const validMinutes = !isNaN(minutes) && minutes >= 0 && minutes <= 59;
                const totalTimeMinutes = (validHours ? hours : 0) * 60 + (validMinutes ? minutes : 0);

                if (themeText && descText && statusValue && totalTimeMinutes > 0) {
                    hasValidTask = true;
                    break;
                }
            }

            if (!hasValidTask) {
                document.getElementById('tasksError').style.display = 'block';
                isValid = false;
            } else {
                document.getElementById('tasksError').style.display = 'none';
            }

            return isValid;
        }

        // –ó–±—ñ—Ä –¥–∞–Ω–∏—Ö —Ñ–æ—Ä–º–∏
        function collectFormData() {
            const tasks = Array.from(document.querySelectorAll('.task-item')).map(item => {
                const theme = item.querySelector('.task-theme');
                const description = item.querySelector('.task-description');
                const hoursEl = item.querySelector('.task-hours');
                const minutesEl = item.querySelector('.task-minutes');
                const status = item.querySelector('.task-status');

                const themeText = theme?.value.trim() || '';
                const descText = description?.value.trim() || '';
                const hours = hoursEl?.value !== '' ? parseInt(hoursEl.value, 10) : 0;
                const minutes = minutesEl?.value !== '' ? parseInt(minutesEl.value, 10) : 0;
                const statusValue = status?.value || 'completed';

                const totalMinutes = hours * 60 + minutes;
                if (!themeText || !descText || totalMinutes === 0) return null;

                // –û–±'—î–¥–Ω—É—î–º–æ –∑–∞–≤–¥–∞–Ω–Ω—è —Ç–∞ –æ–ø–∏—Å –≤ –æ–¥–Ω–µ –ø–æ–ª–µ task
                const taskText = `–ó–∞–≤–¥–∞–Ω–Ω—è: ${themeText}\n\n–û–ø–∏—Å: ${descText}`;

                return {
                    task: taskText,
                    hours: hours,
                    minutes: minutes,
                    status: statusValue
                };
            }).filter(task => task !== null);

            // –û—Ç—Ä–∏–º—É—î–º–æ –ª–æ–∫–∞–ª—å–Ω—É –¥–∞—Ç—É (–Ω–µ UTC) –¥–ª—è –∫–æ—Ä–µ–∫—Ç–Ω–æ–≥–æ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const dateString = `${year}-${month}-${day}`;

            return {
                date: dateString,
                tasks: tasks,
                timestamp: new Date().toISOString()
            };
        }

        // –ì–æ–ª–æ–≤–Ω–∞ –∫–Ω–æ–ø–∫–∞ Telegram
        tg.MainButton.setText('–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –∑–≤—ñ—Ç');
        tg.MainButton.show();
        tg.MainButton.onClick(() => {
            if (validateForm()) {
                const data = collectFormData();
                console.log('–í—ñ–¥–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–∏—Ö:', data);
                console.log('JSON –¥–∞–Ω—ñ:', JSON.stringify(data));

                try {
                    tg.sendData(JSON.stringify(data));
                    tg.close();
                } catch (error) {
                    console.error('–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–∏—Ö:', error);
                    alert('–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –∑–≤—ñ—Ç—É: ' + error.message);
                }
            }
        });

        // –ê–Ω—ñ–º–∞—Ü—ñ—è –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏ –≤–≤–µ–¥–µ–Ω–Ω—ñ
        document.getElementById('reportForm').addEventListener('input', () => {
            if (validateForm()) {
                tg.MainButton.color = '#34c759';
            } else {
                tg.MainButton.color = tg.themeParams.button_color || '#3390ec';
            }
        });
    </script>
</body>
</html>

