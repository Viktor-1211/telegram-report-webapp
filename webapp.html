<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–©–æ–¥–µ–Ω–Ω–∏–π –∑–≤—ñ—Ç</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        h1 {
            font-size: 24px;
            margin-bottom: 10px;
            color: var(--tg-theme-text-color);
        }

        .date {
            color: var(--tg-theme-hint-color, #999);
            margin-bottom: 20px;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--tg-theme-text-color);
        }

        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--tg-theme-hint-color, #ddd);
            border-radius: 8px;
            font-size: 16px;
            background: var(--tg-theme-bg-color, #fff);
            color: var(--tg-theme-text-color, #000);
            font-family: inherit;
        }

        textarea {
            min-height: 120px;
            resize: vertical;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--tg-theme-button-color, #3390ec);
        }

        .task-list {
            margin-top: 10px;
        }

        .task-item {
            margin-bottom: 15px;
            padding: 15px;
            border: 1px solid var(--tg-theme-hint-color, #ddd);
            border-radius: 8px;
            background: var(--tg-theme-secondary-bg-color, #f5f5f5);
        }

        .task-item textarea {
            width: 100%;
            margin-bottom: 10px;
            min-height: 80px;
        }

        .task-item-controls {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .task-item-controls input[type="number"] {
            width: 100px;
            flex-shrink: 0;
        }

        .task-item-controls select {
            width: 150px;
            flex-shrink: 0;
        }

        .btn-remove {
            padding: 12px 16px;
            background: #ff3b30;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            white-space: nowrap;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω—ñ —Å—Ç–∏–ª—ñ –¥–ª—è –º–æ–±—ñ–ª—å–Ω–∏—Ö –ø—Ä–∏—Å—Ç—Ä–æ—ó–≤ */
        @media (max-width: 480px) {
            .task-item-controls {
                gap: 6px;
            }

            .task-item-controls input[type="number"] {
                width: 80px;
                font-size: 14px;
                padding: 10px 8px;
            }

            .task-item-controls select {
                width: 120px;
                font-size: 14px;
                padding: 10px 8px;
            }

            .btn-remove {
                padding: 10px 12px;
                font-size: 12px;
            }
        }

        /* –î–ª—è –¥—É–∂–µ –º–∞–ª–µ–Ω—å–∫–∏—Ö –µ–∫—Ä–∞–Ω—ñ–≤ */
        @media (max-width: 360px) {
            .task-item-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .task-item-controls input[type="number"],
            .task-item-controls select {
                width: 100%;
            }

            .btn-remove {
                width: 100%;
            }
        }

        .btn-add {
            padding: 10px 16px;
            background: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #fff);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
        }

        .error {
            color: #ff3b30;
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }

        .success-message {
            background: #34c759;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìù –©–æ–¥–µ–Ω–Ω–∏–π –∑–≤—ñ—Ç</h1>
        <div class="date" id="currentDate"></div>

        <div class="success-message" id="successMessage">
            ‚úÖ –ó–≤—ñ—Ç —É—Å–ø—ñ—à–Ω–æ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ!
        </div>

        <form id="reportForm">
            <div class="form-group">
                <label for="tasks">–í–∏–∫–æ–Ω–∞–Ω—ñ –∑–∞–≤–¥–∞–Ω–Ω—è *</label>
                <div class="task-list" id="taskList">
                    <div class="task-item">
                        <textarea class="task-input" placeholder="–û–ø–∏—à—ñ—Ç—å –∑–∞–≤–¥–∞–Ω–Ω—è..." required></textarea>
                        <div class="task-item-controls">
                            <input type="number" class="task-hours" min="0" max="24" step="0.5" placeholder="–ì–æ–¥–∏–Ω–∏" required>
                            <select class="task-status" required>
                                <option value="completed">‚úÖ –í–∏–∫–æ–Ω–∞–Ω–æ</option>
                                <option value="in_progress">üîÑ –í –ø—Ä–æ—Ü–µ—Å—ñ</option>
                                <option value="blocked">üö´ –ë–ª–æ–∫–µ—Ä–∏</option>
                            </select>
                            <button type="button" class="btn-remove" onclick="removeTask(this)">‚úï</button>
                        </div>
                    </div>
                </div>
                <button type="button" class="btn-add" onclick="addTask()">+ –î–æ–¥–∞—Ç–∏ –∑–∞–≤–¥–∞–Ω–Ω—è</button>
                <div class="error" id="tasksError">–î–æ–¥–∞–π—Ç–µ —Ö–æ—á–∞ –± –æ–¥–Ω–µ –∑–∞–≤–¥–∞–Ω–Ω—è</div>
            </div>

            <div class="form-group">
                <label for="blockers">–ü—Ä–æ–±–ª–µ–º–∏/–ë–ª–æ–∫–µ—Ä–∏ (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)</label>
                <textarea id="blockers" placeholder="–û–ø–∏—à—ñ—Ç—å –ø—Ä–æ–±–ª–µ–º–∏, —è–∫—â–æ —î..."></textarea>
            </div>

            <div class="form-group">
                <label for="plans">–ü–ª–∞–Ω–∏ –Ω–∞ –∑–∞–≤—Ç—Ä–∞ (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)</label>
                <textarea id="plans" placeholder="–©–æ –ø–ª–∞–Ω—É—î—Ç–µ —Ä–æ–±–∏—Ç–∏ –∑–∞–≤—Ç—Ä–∞..."></textarea>
            </div>

            <div class="form-group">
                <label for="notes">–î–æ–¥–∞—Ç–∫–æ–≤—ñ –Ω–æ—Ç–∞—Ç–∫–∏ (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)</label>
                <textarea id="notes" placeholder="–Ü–Ω—à—ñ –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ..."></textarea>
            </div>
        </form>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –ø–æ—Ç–æ—á–Ω—É –¥–∞—Ç—É
        const dateOptions = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
        document.getElementById('currentDate').textContent = 
            new Date().toLocaleDateString('uk-UA', dateOptions);

        // –î–æ–¥–∞–≤–∞–Ω–Ω—è –Ω–æ–≤–æ–≥–æ –∑–∞–≤–¥–∞–Ω–Ω—è
        function addTask() {
            const taskList = document.getElementById('taskList');
            const taskItem = document.createElement('div');
            taskItem.className = 'task-item';
            taskItem.innerHTML = `
                <textarea class="task-input" placeholder="–û–ø–∏—à—ñ—Ç—å –∑–∞–≤–¥–∞–Ω–Ω—è..." required></textarea>
                <div class="task-item-controls">
                    <input type="number" class="task-hours" min="0" max="24" step="0.5" placeholder="–ì–æ–¥–∏–Ω–∏" required>
                    <select class="task-status" required>
                        <option value="completed">‚úÖ –í–∏–∫–æ–Ω–∞–Ω–æ</option>
                        <option value="in_progress">üîÑ –í –ø—Ä–æ—Ü–µ—Å—ñ</option>
                        <option value="blocked">üö´ –ë–ª–æ–∫–µ—Ä–∏</option>
                    </select>
                    <button type="button" class="btn-remove" onclick="removeTask(this)">‚úï</button>
                </div>
            `;
            taskList.appendChild(taskItem);
        }

        // –í–∏–¥–∞–ª–µ–Ω–Ω—è –∑–∞–≤–¥–∞–Ω–Ω—è
        function removeTask(button) {
            const taskList = document.getElementById('taskList');
            if (taskList.children.length > 1) {
                // –ó–Ω–∞—Ö–æ–¥–∏–º–æ –±–∞—Ç—å–∫—ñ–≤—Å—å–∫–∏–π task-item (button -> task-item-controls -> task-item)
                const taskItem = button.closest('.task-item');
                if (taskItem) {
                    taskItem.remove();
                }
            } else {
                alert('–ú–∞—î –±—É—Ç–∏ —Ö–æ—á–∞ –± –æ–¥–Ω–µ –∑–∞–≤–¥–∞–Ω–Ω—è');
            }
        }

        // –í–∞–ª—ñ–¥–∞—Ü—ñ—è —Ñ–æ—Ä–º–∏
        function validateForm() {
            let isValid = true;

            // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑–∞–≤–¥–∞–Ω—å —Ç–∞ –≥–æ–¥–∏–Ω
            const taskItems = document.querySelectorAll('.task-item');
            const validTasks = Array.from(taskItems).filter(item => {
                const input = item.querySelector('.task-input');
                const hours = item.querySelector('.task-hours');
                const status = item.querySelector('.task-status');
                const hasTask = input && input.value.trim() !== '';
                const hasHours = hours && hours.value && parseFloat(hours.value) > 0;
                const hasStatus = status && status.value;
                return hasTask && hasHours && hasStatus;
            });
            
            if (validTasks.length === 0) {
                document.getElementById('tasksError').style.display = 'block';
                document.getElementById('tasksError').textContent = '–î–æ–¥–∞–π—Ç–µ —Ö–æ—á–∞ –± –æ–¥–Ω–µ –∑–∞–≤–¥–∞–Ω–Ω—è –∑ –≤–∫–∞–∑–∞–Ω–∏–º–∏ –≥–æ–¥–∏–Ω–∞–º–∏';
                isValid = false;
            } else {
                document.getElementById('tasksError').style.display = 'none';
            }

            return isValid;
        }

        // –ó–±—ñ—Ä –¥–∞–Ω–∏—Ö —Ñ–æ—Ä–º–∏
        function collectFormData() {
            const tasks = Array.from(document.querySelectorAll('.task-item')).map(item => {
                const textarea = item.querySelector('.task-input');
                const hours = item.querySelector('.task-hours');
                const status = item.querySelector('.task-status');
                const taskText = textarea ? textarea.value.trim() : '';
                const taskHours = hours ? parseFloat(hours.value) : 0;
                const taskStatus = status ? status.value : 'completed';
                
                if (taskText === '' || taskHours <= 0) return null;
                
                return {
                    task: taskText,
                    hours: taskHours,
                    status: taskStatus
                };
            }).filter(task => task !== null);

            return {
                date: new Date().toISOString().split('T')[0],
                tasks: tasks,
                blockers: document.getElementById('blockers').value.trim(),
                plans: document.getElementById('plans').value.trim(),
                notes: document.getElementById('notes').value.trim(),
                timestamp: new Date().toISOString()
            };
        }

        // –ì–æ–ª–æ–≤–Ω–∞ –∫–Ω–æ–ø–∫–∞ Telegram
        tg.MainButton.setText('–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –∑–≤—ñ—Ç');
        tg.MainButton.show();
        tg.MainButton.onClick(() => {
            if (validateForm()) {
                const data = collectFormData();
                console.log('–í—ñ–¥–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–∏—Ö:', data);
                console.log('JSON –¥–∞–Ω—ñ:', JSON.stringify(data));
                
                try {
                    tg.sendData(JSON.stringify(data));
                    console.log('–î–∞–Ω—ñ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ');
                    tg.close();
                } catch (error) {
                    console.error('–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–∏—Ö:', error);
                    alert('–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –∑–≤—ñ—Ç—É: ' + error.message);
                }
            } else {
                console.log('–§–æ—Ä–º–∞ –Ω–µ –≤–∞–ª—ñ–¥–Ω–∞');
            }
        });

        // –ê–Ω—ñ–º–∞—Ü—ñ—è –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏ –≤–≤–µ–¥–µ–Ω–Ω—ñ
        document.getElementById('reportForm').addEventListener('input', () => {
            if (validateForm()) {
                tg.MainButton.color = '#34c759';
            } else {
                tg.MainButton.color = tg.themeParams.button_color || '#3390ec';
            }
        });
    </script>
</body>
</html>
